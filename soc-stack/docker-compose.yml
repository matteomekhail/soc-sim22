version: '3.8'

networks:
  soc-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/24

volumes:
  wazuh-indexer-data:
  wazuh-manager-data:
  grafana-data:
  loki-data:

services:
  # ============================================================
  # CORE SERVICES (always started)
  # ============================================================

  wazuh-indexer:
    image: wazuh/wazuh-indexer:${WAZUH_INDEXER_VERSION:-4.7.2}
    container_name: wcace-wazuh-indexer
    hostname: wazuh-indexer
    restart: unless-stopped
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - "bootstrap.memory_lock=true"
      - "discovery.type=single-node"
      - "plugins.security.ssl.http.enabled=true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data:/var/lib/wazuh-indexer
    ports:
      - "9200:9200"
    networks:
      soc-net:
        ipv4_address: 172.25.0.10

  wazuh-manager:
    image: wazuh/wazuh-manager:${WAZUH_MANAGER_VERSION:-4.7.2}
    container_name: wcace-wazuh-manager
    hostname: wazuh-manager
    restart: unless-stopped
    depends_on:
      - wazuh-indexer
    environment:
      - INDEXER_URL=${INDEXER_URL:-https://wazuh-indexer:9200}
      - INDEXER_USERNAME=${INDEXER_USERNAME:-admin}
      - INDEXER_PASSWORD=${INDEXER_PASSWORD:-SecretPassword}
      - FILEBEAT_SSL_VERIFICATION_MODE=none
    volumes:
      - wazuh-manager-data:/var/ossec/data
      - ./wazuh/ossec.conf:/var/ossec/etc/ossec.conf:ro
      - ./suricata/rules/local.rules:/var/ossec/ruleset/rules/local_rules.xml:ro
    ports:
      - "1514:1514/udp"
      - "1515:1515"
      - "514:514/udp"
      - "55000:55000"
    networks:
      soc-net:
        ipv4_address: 172.25.0.11

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:${WAZUH_DASHBOARD_VERSION:-4.7.2}
    container_name: wcace-wazuh-dashboard
    hostname: wazuh-dashboard
    restart: unless-stopped
    depends_on:
      - wazuh-indexer
      - wazuh-manager
    environment:
      - INDEXER_USERNAME=${INDEXER_USERNAME:-admin}
      - INDEXER_PASSWORD=${INDEXER_PASSWORD:-SecretPassword}
      - WAZUH_API_URL=https://wazuh-manager:55000
      - API_USERNAME=${WAZUH_API_USER:-wazuh-wui}
      - API_PASSWORD=${WAZUH_API_PASSWORD:-MyS3cr3tP4ssw0rd}
    ports:
      - "5601:5601"
    networks:
      soc-net:
        ipv4_address: 172.25.0.12

  suricata:
    image: jasonish/suricata:latest
    container_name: wcace-suricata
    hostname: suricata
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_NICE
    network_mode: host
    volumes:
      - ./suricata/suricata.yaml:/etc/suricata/suricata.yaml:ro
      - ./suricata/rules/local.rules:/var/lib/suricata/rules/local.rules:ro
    command: >
      suricata -c /etc/suricata/suricata.yaml -i eth0 -S /var/lib/suricata/rules/local.rules

  loki:
    image: grafana/loki:2.9.4
    container_name: wcace-loki
    hostname: loki
    restart: unless-stopped
    volumes:
      - ./loki/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      soc-net:
        ipv4_address: 172.25.0.20

  promtail:
    image: grafana/promtail:2.9.4
    container_name: wcace-promtail
    hostname: promtail
    restart: unless-stopped
    depends_on:
      - loki
    volumes:
      - ./promtail/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      soc-net:
        ipv4_address: 172.25.0.21

  grafana:
    image: grafana/grafana-oss:10.3.1
    container_name: wcace-grafana
    hostname: grafana
    restart: unless-stopped
    depends_on:
      - loki
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    networks:
      soc-net:
        ipv4_address: 172.25.0.22

  # ============================================================
  # ON-DEMAND SERVICES (via --profile)
  # ============================================================

  # Incident Response platform
  thehive:
    image: strangebee/thehive:5.2
    container_name: wcace-thehive
    hostname: thehive
    restart: unless-stopped
    profiles:
      - ir
    ports:
      - "9000:9000"
    networks:
      soc-net:
        ipv4_address: 172.25.0.30

  # Vulnerable web application
  dvwa:
    image: vulnerables/web-dvwa:latest
    container_name: wcace-dvwa
    hostname: dvwa
    restart: unless-stopped
    profiles:
      - webapp
    ports:
      - "8081:80"
    networks:
      soc-net:
        ipv4_address: 172.25.0.40

  # Vulnerable Flask API
  vuln-api:
    build:
      context: ../scenarios/22-api-vulnerability-exploitation/attack
      dockerfile: Dockerfile
    container_name: wcace-vuln-api
    hostname: vuln-api
    restart: unless-stopped
    profiles:
      - api
    ports:
      - "8080:8080"
    networks:
      soc-net:
        ipv4_address: 172.25.0.41

  # Phishing site simulation
  phishing-nginx:
    image: nginx:alpine
    container_name: wcace-phishing-nginx
    hostname: phishing-nginx
    restart: unless-stopped
    profiles:
      - phishing
    volumes:
      - ../scenarios/02-domain-spoofing-data-theft/attack/phishing-site:/usr/share/nginx/html:ro
    ports:
      - "8082:80"
    networks:
      soc-net:
        ipv4_address: 172.25.0.42

  # DNS for tunnelling scenarios
  coredns:
    image: coredns/coredns:1.11.1
    container_name: wcace-coredns
    hostname: coredns
    restart: unless-stopped
    profiles:
      - dns
    ports:
      - "5353:53/udp"
      - "5353:53/tcp"
    volumes:
      - ../scenarios/17-dns-tunnelling/config/Corefile:/etc/coredns/Corefile:ro
    command: -conf /etc/coredns/Corefile
    networks:
      soc-net:
        ipv4_address: 172.25.0.43
