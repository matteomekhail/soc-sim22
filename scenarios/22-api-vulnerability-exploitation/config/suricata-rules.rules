# Scenario 22: API Vulnerability Exploitation Detection Rules for Suricata
# These rules supplement the global rules in soc-stack/suricata/rules/local.rules

# API1: Broken Object Level Authorization -- rapid sequential ID enumeration
alert http any any -> $API_SERVERS any (msg:"S22: API IDOR - Sequential user ID enumeration"; flow:to_server,established; content:"/api/users/"; http_uri; pcre:"/\/api\/users\/\d+/"; threshold:type both, track by_src, count 5, seconds 10; sid:9220001; rev:1; classtype:web-application-attack;)

# API2: Broken Authentication -- JWT algorithm manipulation
alert http any any -> $API_SERVERS any (msg:"S22: API Auth - JWT algorithm none bypass attempt"; flow:to_server,established; content:"eyJ"; http_header; content:"\"alg\""; content:"\"none\""; distance:0; sid:9220002; rev:1; classtype:web-application-attack;)

# API2: Broken Authentication -- brute-force login attempts
alert http any any -> $API_SERVERS any (msg:"S22: API Auth - Brute force login attempts"; flow:to_server,established; content:"POST"; http_method; content:"/api/auth/login"; http_uri; threshold:type both, track by_src, count 10, seconds 30; sid:9220003; rev:1; classtype:attempted-user;)

# API5: Broken Function Level Authorization -- non-admin accessing admin endpoints
alert http any any -> $API_SERVERS any (msg:"S22: API Auth Bypass - Admin endpoint access attempt"; flow:to_server,established; content:"/api/admin/"; http_uri; sid:9220004; rev:1; classtype:web-application-attack;)

# API6: Mass Assignment -- role field in registration payload
alert http any any -> $API_SERVERS any (msg:"S22: API Mass Assignment - Role injection in registration"; flow:to_server,established; content:"POST"; http_method; content:"/api/auth/register"; http_uri; content:"\"role\""; http_client_body; sid:9220005; rev:1; classtype:web-application-attack;)

# API8: SQL Injection -- UNION SELECT in API query parameter
alert http any any -> $API_SERVERS any (msg:"S22: API SQLi - UNION SELECT in query parameter"; flow:to_server,established; content:"/api/data"; http_uri; content:"UNION"; nocase; content:"SELECT"; nocase; distance:0; sid:9220006; rev:1; classtype:web-application-attack;)

# API8: SQL Injection -- OR 1=1 boolean injection
alert http any any -> $API_SERVERS any (msg:"S22: API SQLi - Boolean injection in query parameter"; flow:to_server,established; content:"/api/data"; http_uri; pcre:"/OR\s+[\'\"]?\d+=\d+/i"; sid:9220007; rev:1; classtype:web-application-attack;)

# API attack tool detection -- common API fuzzing user agents
alert http any any -> $API_SERVERS any (msg:"S22: API Attack Tool - Suspicious user agent detected"; flow:to_server,established; pcre:"/(sqlmap|nikto|api-fuzzer|burp|postman-token|dirbuster)/i"; http_user_agent; sid:9220008; rev:1; classtype:web-application-attack;)
