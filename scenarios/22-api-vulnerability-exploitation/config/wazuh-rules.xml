<!-- Scenario 22: API Vulnerability Exploitation Detection Rules for Wazuh -->
<group name="wcace,api-attack,web-attack,">

  <!-- API1: Broken Object Level Authorization (IDOR) -->
  <rule id="100800" level="10">
    <if_group>web|accesslog</if_group>
    <regex>/api/users/\d+</regex>
    <description>WCACE S22: API IDOR - User profile access via direct object reference</description>
    <mitre>
      <id>T1190</id>
    </mitre>
    <group>attack,api,idor,</group>
  </rule>

  <rule id="100801" level="12" frequency="5" timeframe="30">
    <if_matched_group>idor</if_matched_group>
    <description>WCACE S22: API IDOR - Sequential user ID enumeration detected</description>
    <mitre>
      <id>T1190</id>
    </mitre>
    <group>attack,api,idor,</group>
  </rule>

  <!-- API2: Broken Authentication -->
  <rule id="100802" level="10">
    <if_group>web|accesslog</if_group>
    <match>alg|none|jwt-cracker</match>
    <description>WCACE S22: API Auth Bypass - JWT algorithm manipulation attempt</description>
    <mitre>
      <id>T1190</id>
      <id>T1078</id>
    </mitre>
    <group>attack,api,auth-bypass,</group>
  </rule>

  <rule id="100803" level="12" frequency="10" timeframe="60">
    <if_group>web|accesslog</if_group>
    <match>/api/auth/login</match>
    <description>WCACE S22: API Brute Force - Multiple failed login attempts</description>
    <mitre>
      <id>T1190</id>
      <id>T1059</id>
    </mitre>
    <group>attack,api,brute-force,</group>
  </rule>

  <!-- API5: Broken Function Level Authorization -->
  <rule id="100804" level="12">
    <if_group>web|accesslog</if_group>
    <match>/api/admin/</match>
    <description>WCACE S22: API Auth Bypass - Admin endpoint accessed by non-admin</description>
    <mitre>
      <id>T1190</id>
    </mitre>
    <group>attack,api,auth-bypass,</group>
  </rule>

  <!-- API6: Mass Assignment -->
  <rule id="100805" level="10">
    <if_group>web|accesslog</if_group>
    <match>/api/auth/register</match>
    <regex>role|admin</regex>
    <description>WCACE S22: API Mass Assignment - Role injection in user registration</description>
    <mitre>
      <id>T1190</id>
    </mitre>
    <group>attack,api,mass-assignment,</group>
  </rule>

  <!-- API8: SQL Injection -->
  <rule id="100806" level="12">
    <if_group>web|accesslog</if_group>
    <match>UNION|SELECT|union|select</match>
    <regex>/api/data</regex>
    <description>WCACE S22: API SQL Injection - UNION SELECT in query parameter</description>
    <mitre>
      <id>T1190</id>
      <id>T1059</id>
    </mitre>
    <group>attack,api,sqli,</group>
  </rule>

  <!-- Composite: Active API attack campaign -->
  <rule id="100807" level="14" frequency="8" timeframe="120">
    <if_matched_group>api</if_matched_group>
    <description>WCACE S22: Active API attack campaign - Multiple OWASP API Top 10 vectors detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1059</id>
    </mitre>
    <group>attack,api,campaign,</group>
  </rule>

</group>
