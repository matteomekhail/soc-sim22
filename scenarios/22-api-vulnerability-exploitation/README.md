# Scenario 22: API Vulnerability Exploitation

## Overview
Simulate a comprehensive API attack exploiting OWASP API Security Top 10 vulnerabilities against a REST API. The attacker discovers and exploits broken authentication (JWT bypass), broken object-level authorization (IDOR), SQL injection in query parameters, mass assignment, excessive data exposure, and lack of rate limiting to gain unauthorized access and exfiltrate data.

## MITRE ATT&CK Mapping

| Tactic | Technique | ID |
|--------|-----------|-----|
| Initial Access | Exploit Public-Facing Application | T1190 |
| Execution | Command and Scripting Interpreter | T1059 |
| Persistence | Server Software Component: Web Shell | T1505 |
| Credential Access | Valid Accounts | T1078 |
| Collection | Data from Information Repositories | T1213 |

## Attack Flow

```
1. Reconnaissance       -> Enumerate API endpoints, discover OpenAPI spec
2. Broken Auth          -> Bypass JWT authentication (weak secret, algorithm confusion)
3. BOLA / IDOR         -> Access other users' data by manipulating object IDs
4. Excessive Exposure   -> Harvest sensitive fields returned by API
5. Mass Assignment      -> Elevate privileges by injecting role field in registration
6. SQL Injection        -> Extract database via injectable query parameters
7. Rate Limit Abuse     -> Brute-force credentials with no throttling
8. Admin Bypass         -> Access admin endpoints without proper authorization
```

## Components

### Vulnerable API (`attack/vuln_api.py`)
- Flask REST API with intentionally vulnerable endpoints
- JWT authentication with weak secret and no algorithm validation
- SQLite database with user, financial, and API key data
- Endpoints: `/api/auth/login`, `/api/auth/register`, `/api/users/<id>`, `/api/admin/users`, `/api/data`

### Docker (`attack/Dockerfile`)
- Containerized vulnerable API for isolated testing

### Attack Simulation (`attack/simulate_attack.py`)
- Automated exploitation of all OWASP API Top 10 categories
- Progressive attack escalation with detailed logging
- Generates JSON logs and Suricata/Wazuh-compatible events

### Detection Rules
- **Suricata**: `config/suricata-rules.rules` - API attack traffic inspection (JWT manipulation, SQLi, IDOR patterns)
- **Wazuh**: `config/wazuh-rules.xml` - API security correlation rules (rule IDs 100800+)

### Verification (`detect/verify_detection.py`)
- Checks Suricata alerts for API attack signatures
- Validates Wazuh alert generation
- Reports detection coverage

### Response
- **Containment** (`respond/containment.py`): API key revocation, rate limiting enforcement, IP blocking
- **Playbook** (`respond/playbook.md`): Full IR playbook for API-based attacks

## How to Run

```bash
# 1. Start the vulnerable API
python3 attack/vuln_api.py &

# Or use Docker:
cd attack && docker build -t vuln-api . && docker run -p 8080:8080 vuln-api

# 2. Run the attack simulation
python3 attack/simulate_attack.py

# 3. Verify detection
python3 detect/verify_detection.py

# 4. Run containment response
python3 respond/containment.py

# 5. Review IR playbook
cat respond/playbook.md
```

## Prerequisites
- SOC stack running (`soc-stack/scripts/start-core.sh`)
- Or standalone mode (generates local log files)

## Sample Payloads
```
JWT bypass:       {"alg":"none"} + empty signature
IDOR:             GET /api/users/1 (as user 2)
Mass assignment:  POST /api/auth/register {"role":"admin"}
SQLi:             GET /api/data?query=' UNION SELECT * FROM users--
Rate limit:       100+ login attempts with no throttling
Admin bypass:     GET /api/admin/users (with regular user JWT)
```

## Expected Alerts
- Suricata SID 9220001-9220008: API attack patterns
- Wazuh Rule 100800-100807: API vulnerability exploitation correlation
