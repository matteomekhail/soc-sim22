<!-- Scenario 20: Ransomware via Exploit Kit Detection Rules for Wazuh -->
<!-- COMBO scenario: Watering Hole (S12) + Ransomware (S08) -->
<group name="wcace,ransomware,exploit_kit,watering_hole,">

  <!-- Watering Hole: Access to known compromised news/industry site -->
  <rule id="100580" level="11">
    <if_group>web_log</if_group>
    <match>news-portal.test</match>
    <description>WCACE S20: Access to known watering hole site detected</description>
    <mitre>
      <id>T1189</id>
    </mitre>
    <group>watering_hole,initial_access,</group>
  </rule>

  <!-- Watering Hole: Redirect from compromised site to exploit kit -->
  <rule id="100581" level="12">
    <if_sid>100580</if_sid>
    <match>302|redirect|gate</match>
    <description>WCACE S20: Watering hole redirect to exploit kit infrastructure detected</description>
    <mitre>
      <id>T1189</id>
    </mitre>
    <group>watering_hole,exploit_kit,</group>
  </rule>

  <!-- Exploit Kit: Ransomware payload delivered via browser exploit -->
  <rule id="100582" level="13">
    <if_group>web_log</if_group>
    <match>exploit|payload</match>
    <regex>\.exe|\.dll|\.scr</regex>
    <description>WCACE S20: Exploit kit delivered ransomware payload via browser vulnerability</description>
    <mitre>
      <id>T1189</id>
      <id>T1203</id>
    </mitre>
    <group>exploit_kit,ransomware,</group>
  </rule>

  <!-- Process: Ransomware process launched by browser -->
  <rule id="100583" level="13">
    <if_group>process_monitor</if_group>
    <match>chrome.exe|firefox.exe|msedge.exe</match>
    <regex>svchost_patch|update.*\.exe</regex>
    <description>WCACE S20: Ransomware process spawned by browser - exploit kit payload executing</description>
    <mitre>
      <id>T1203</id>
    </mitre>
    <group>exploit_kit,ransomware,execution,</group>
  </rule>

  <!-- FIM: Mass file modification (ransomware indicator) -->
  <rule id="100584" level="14" frequency="10" timeframe="30">
    <if_group>syscheck</if_group>
    <description>WCACE S20: Mass file modification detected - ransomware encryption in progress</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>ransomware,fim,</group>
  </rule>

  <!-- FIM: Ransomware file extension detected -->
  <rule id="100585" level="14">
    <if_group>syscheck</if_group>
    <match>.encrypted|.locked|.crypted|.enc</match>
    <description>WCACE S20: Ransomware file extension detected - files being encrypted</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>ransomware,fim,</group>
  </rule>

  <!-- FIM: Ransom note file creation -->
  <rule id="100586" level="15">
    <if_group>syscheck</if_group>
    <match>RANSOM_NOTE|DECRYPT_FILES|HOW_TO_RECOVER</match>
    <description>WCACE S20: Ransom note file detected - ransomware confirmed</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>ransomware,fim,</group>
  </rule>

  <!-- C2: Ransomware key exchange communication -->
  <rule id="100587" level="14">
    <if_group>firewall</if_group>
    <match>203.0.113.100</match>
    <description>WCACE S20: Ransomware C2 communication - encryption key exchange detected</description>
    <mitre>
      <id>T1573</id>
    </mitre>
    <group>ransomware,c2,</group>
  </rule>

  <!-- C2: Periodic beacon from ransomware-infected host -->
  <rule id="100588" level="13" frequency="3" timeframe="120">
    <if_matched_sid>100587</if_matched_sid>
    <same_source_ip />
    <description>WCACE S20: C2 beacon detected from ransomware-infected host</description>
    <mitre>
      <id>T1573</id>
    </mitre>
    <group>ransomware,c2,</group>
  </rule>

  <!-- Correlation: Full ransomware-via-exploit-kit kill chain -->
  <rule id="100589" level="15" frequency="3" timeframe="600">
    <if_matched_group>ransomware</if_matched_group>
    <description>WCACE S20: Ransomware-via-exploit-kit kill chain - watering hole to file encryption to C2</description>
    <mitre>
      <id>T1189</id>
      <id>T1203</id>
      <id>T1486</id>
      <id>T1573</id>
    </mitre>
    <group>ransomware,exploit_kit,watering_hole,kill_chain,</group>
  </rule>

</group>
