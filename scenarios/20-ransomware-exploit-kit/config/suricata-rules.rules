# Scenario 20: Ransomware via Exploit Kit Detection Rules for Suricata
# COMBO scenario: Watering Hole (S12) + Ransomware (S08)
# These rules supplement the global rules in soc-stack/suricata/rules/local.rules

# --- Watering Hole Detection ---

alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"S20: Watering hole - suspicious redirect from compromised news site"; flow:to_client,established; content:"302"; http_stat_code; content:"gate"; http_location; sid:9200001; rev:1; classtype:trojan-activity;)

alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"S20: Exploit kit landing page accessed from watering hole redirect"; flow:to_server,established; content:"/landing"; http_uri; content:"gate"; http_uri; sid:9200002; rev:1; classtype:trojan-activity;)

# --- Exploit Kit Payload Delivery ---

alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"S20: Exploit kit delivering PE executable payload"; flow:to_client,established; content:"Content-Type|3a 20|application/x-msdownload"; http_header; content:"svchost"; http_uri; sid:9200003; rev:1; classtype:trojan-activity;)

# --- Ransomware C2 Communication ---

alert tls $HOME_NET any -> $EXTERNAL_NET any (msg:"S20: Ransomware C2 key exchange - TLS to known malicious domain"; flow:to_server,established; content:"evil-cdn.test"; tls.sni; sid:9200004; rev:1; classtype:trojan-activity;)

alert tcp $HOME_NET any -> $EXTERNAL_NET 443 (msg:"S20: Ransomware C2 periodic beacon detected"; flow:to_server,established; detection_filter:track by_src, count 3, seconds 120; sid:9200005; rev:1; classtype:trojan-activity;)

# --- Ransomware Key Exchange Indicators ---

alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"S20: Ransomware key exchange - POST with encrypted payload to C2"; flow:to_server,established; content:"POST"; http_method; content:"key-exchange"; http_uri; sid:9200006; rev:1; classtype:trojan-activity;)
