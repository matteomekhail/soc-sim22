# Scenario 20: Ransomware via Exploit Kit

## Overview
This is a **combination scenario** merging Scenario 12 (Watering Hole Attack) and Scenario 8 (Phishing & Ransomware). A user visits a compromised watering hole site, an exploit kit delivers a payload, the payload deploys ransomware that encrypts files in a sandboxed directory, and the ransomware communicates with a C2 server for key exchange. Detection covers web proxy logs, Wazuh FIM alerts, and Suricata network signatures across the full kill chain.

**Tier:** 2 (Full attack simulation with detection and response)

## MITRE ATT&CK Mapping

| Tactic | Technique | ID |
|--------|-----------|-----|
| Initial Access | Drive-By Compromise | T1189 |
| Execution | Exploitation for Client Execution | T1203 |
| Impact | Data Encrypted for Impact | T1486 |
| Command and Control | Encrypted Channel | T1573 |

## Attack Flow

```
1. Watering Hole        -> User visits compromised industry news site
2. Exploit Kit Delivery -> Injected script redirects to exploit kit
3. Ransomware Deploy    -> Exploit kit drops ransomware payload
4. File Encryption      -> Ransomware encrypts files in /tmp/wcace-sandbox/
5. C2 Key Exchange      -> Encryption key sent to C2 server via HTTPS
```

## Components

### Attack Simulation (`attack/simulate_attack.py`)
- **Phase 1:** User visits watering hole site (compromised industry news portal)
- **Phase 2:** Exploit kit serves payload via browser vulnerability
- **Phase 3:** Ransomware deployed -- creates sandbox files and encrypts them with Fernet
- **Phase 4:** C2 communication for encryption key exchange and ransom note drop

All file operations are sandboxed to `/tmp/wcace-sandbox/` with strict safety checks.

### Detection Rules
- **Suricata:** `config/suricata-rules.rules` -- Watering hole redirect, exploit kit payload, ransomware C2
- **Wazuh:** `config/wazuh-rules.xml` -- Watering hole access, exploit kit activity, mass file encryption, ransomware indicators (rule IDs 100580+)

### Verification (`detect/verify_detection.py`)
- Checks local logs for watering hole and ransomware events
- Validates FIM alert generation for file encryption
- Reports detection coverage

### Response
- **`respond/containment.py`** -- Block watering hole site, kill ransomware process, preserve encryption key, isolate host
- **`respond/playbook.md`** -- Full incident response playbook for ransomware-via-exploit-kit incidents

## How to Run

```bash
# 1. Install dependencies
pip install -r attack/requirements.txt

# 2. Run the full attack simulation
python3 attack/simulate_attack.py

# 3. Verify detection
python3 detect/verify_detection.py

# 4. Run containment response
python3 respond/containment.py

# 5. Review IR playbook
cat respond/playbook.md
```

## Prerequisites
- Python 3.10+
- SOC stack running (`soc-stack/scripts/start-core.sh`) or standalone mode (generates local log files)
- The `cryptography` package (`pip install cryptography`)

## Safety Notes
- All file encryption is restricted to `/tmp/wcace-sandbox/` only
- The script includes multiple safety checks to prevent operating outside the sandbox
- Encryption keys are logged for recovery during exercises
- No real malware is used -- encryption uses standard Fernet symmetric encryption
- No actual watering hole sites are created or compromised

## Expected Alerts
- Suricata SID 9200001-9200006: Watering hole and ransomware network indicators
- Wazuh Rule 100580-100589: Watering hole access, exploit kit, file encryption, C2 communication
