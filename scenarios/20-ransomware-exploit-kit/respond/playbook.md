# Incident Response Playbook: Ransomware via Exploit Kit

## Scenario 20 - Ransomware via Exploit Kit (Combo: S12 Watering Hole + S08 Ransomware)

### Severity: CRITICAL
### MITRE ATT&CK: T1189 (Drive-By Compromise), T1203 (Exploitation for Client Execution), T1486 (Data Encrypted for Impact), T1573 (Encrypted Channel)

---

## 1. Detection
- [ ] Suricata alert: Watering hole redirect from compromised site (SID 9200001)
- [ ] Suricata alert: Exploit kit landing page accessed (SID 9200002)
- [ ] Suricata alert: Ransomware PE download from exploit kit (SID 9200003)
- [ ] Suricata alert: Ransomware C2 key exchange (SID 9200004)
- [ ] Wazuh alert: Watering hole site accessed (rule 100580)
- [ ] Wazuh alert: Exploit kit delivered ransomware payload (rule 100582)
- [ ] Wazuh alert: Mass file modification detected (rule 100584)
- [ ] Wazuh alert: Ransomware file extension detected (rule 100585)
- [ ] Wazuh alert: Ransom note file created (rule 100586)
- [ ] Wazuh alert: C2 key exchange detected (rule 100587)
- [ ] Wazuh alert: Full kill chain correlation (rule 100589)
- [ ] Endpoint: RANSOM_NOTE.txt files appearing in directories
- [ ] Users reporting inability to open files

## 2. Triage (First 10 minutes)
- [ ] **CRITICAL**: Determine if encryption is still in progress
- [ ] Identify the victim user and workstation
- [ ] Determine the initial access vector (watering hole site)
- [ ] Check if the exploit kit infrastructure is still active
- [ ] Identify other users who visited the same watering hole site
- [ ] Assess the scope: how many files/systems are affected?
- [ ] Check if the C2 communication is still active
- [ ] Locate any saved encryption keys (from logs or C2 intercept)
- [ ] Verify backups are available and not affected

## 3. Containment (First 15 minutes)
- [ ] **Immediate**: Kill the ransomware process on all affected hosts
- [ ] **Immediate**: Isolate affected hosts from the network
- [ ] **Immediate**: Block watering hole site domain at DNS/proxy
- [ ] **Immediate**: Block exploit kit domain and C2 server at firewall
- [ ] Prevent lateral movement: block SMB, RDP between workstations
- [ ] Preserve any encryption keys found in memory or logs
- [ ] Do NOT restart affected machines (encryption key may be in memory)
- [ ] Notify all users to stop visiting the watering hole site

### Containment Commands
```bash
# Kill ransomware process
taskkill /IM svchost_patch.exe /F

# Block C2 and exploit kit at firewall
iptables -A OUTPUT -d <C2_SERVER_IP> -j DROP
iptables -A OUTPUT -d <EXPLOIT_KIT_IP> -j DROP

# DNS sinkhole for watering hole
echo "0.0.0.0 news-portal.test" >> /etc/hosts
echo "0.0.0.0 cdn-assets.newsportal.test" >> /etc/hosts
echo "0.0.0.0 updates.evil-cdn.test" >> /etc/hosts

# Isolate victim from network
iptables -A OUTPUT -j DROP
iptables -A INPUT -s 10.0.0.0/24 -j ACCEPT  # Management only

# Run containment script
python3 respond/containment.py
```

## 4. Eradication
- [ ] Remove ransomware payload from all affected systems
- [ ] Remove persistence mechanisms (registry keys, scheduled tasks)
- [ ] Clear browser cache to remove exploit kit JavaScript
- [ ] Patch the exploited browser vulnerability (CVE-2021-21224)
- [ ] Scan all systems with updated AV/EDR for ransomware variants
- [ ] Verify the watering hole site owner has been notified
- [ ] Check for additional payloads dropped by the exploit kit
- [ ] Audit all users who visited the compromised site in the last 7 days
- [ ] Remove RANSOM_NOTE.txt files from all affected directories
- [ ] Verify no lateral movement occurred

### Remediation Steps
```bash
# Remove ransomware files
del /F /Q "%TEMP%\svchost_patch.exe"

# Remove persistence
reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v SvcHostPatch /f

# Clear browser cache
# Chrome: --delete-profile-data-on-close

# Full AV scan
MpCmdRun.exe -Scan -ScanType 2
```

## 5. Recovery
- [ ] **Option A**: Recover files using saved encryption key (if available)
  ```bash
  python3 respond/containment.py  # Includes recovery function
  ```
- [ ] **Option B**: Restore files from backup
  - Verify backups are clean (not encrypted)
  - Restore from most recent clean backup
  - Validate restored data integrity
- [ ] **Option C**: If no key or backup, assess data loss impact
- [ ] Re-image affected workstations from known-good image
- [ ] Update browser and all plugins to latest versions
- [ ] Re-enable network access gradually with monitoring
- [ ] Monitor recovered systems for 72 hours for re-infection

## 6. Lessons Learned
- [ ] Document complete attack timeline: watering hole to encryption
- [ ] Identify why the watering hole site was not blocked
- [ ] Assess browser patching cadence -- was the vulnerability known?
- [ ] Evaluate backup strategy -- were backups available and current?
- [ ] Measure time from initial compromise to detection
- [ ] Determine total data loss (files not recoverable)
- [ ] Assess if web proxy with SSL inspection would have prevented the download
- [ ] Review the effectiveness of FIM alerts for ransomware detection

## 7. Prevention Measures
- **Web Security**: Deploy web proxy with SSL inspection and URL categorization
- **Browser Hardening**: Keep browsers auto-updated, disable unnecessary plugins
- **Network Segmentation**: Limit workstation-to-workstation communication
- **Backup Strategy**: Implement 3-2-1 backup rule (3 copies, 2 media, 1 offsite)
- **Endpoint Protection**: Deploy EDR with exploit prevention and ransomware detection
- **DNS Security**: Use DNS filtering to block known exploit kit domains
- **Threat Intelligence**: Subscribe to feeds for watering hole and exploit kit indicators
- **User Awareness**: Train users on risks of industry news/forum sites
- **Patch Management**: Automate browser and plugin patching (< 24h for critical CVEs)
- **File Integrity Monitoring**: Enable Wazuh FIM on critical file shares
- **Application Whitelisting**: Restrict executable downloads to approved sources
- **Incident Response**: Maintain and test ransomware-specific IR procedures quarterly

## 8. Related Scenarios
- **Scenario 08**: Phishing & Ransomware (same encryption methodology)
- **Scenario 12**: Watering Hole Attack (same initial access vector)
- **Scenario 18**: Drive-By Download (similar exploit kit delivery)
