# =============================================================================
# Scenario 02: Domain Spoofing & Data Theft - Suricata Rules
# =============================================================================
# Detect access to spoofed/lookalike domains and credential exfiltration.
# Deploy to: /etc/suricata/rules/local-scenario02.rules
# Then add to suricata.yaml under rule-files.
# =============================================================================

# --- DNS-based detection ---

# Detect DNS query for the spoofed domain (acmec0rp.local)
alert dns any any -> any 53 (msg:"SC02 - DNS query for spoofed domain acmec0rp.local"; dns.query; content:"acmec0rp.local"; nocase; classtype:social-engineering; sid:2000201; rev:1; metadata:scenario 02, mitre_attack T1583.001;)

# Detect DNS query for the phishing domain
alert dns any any -> any 53 (msg:"SC02 - DNS query for phishing domain acmecorp-login.test"; dns.query; content:"acmecorp-login.test"; nocase; classtype:social-engineering; sid:2000202; rev:1; metadata:scenario 02, mitre_attack T1566.002;)

# Detect DNS queries to known-bad registrar
alert dns any any -> any 53 (msg:"SC02 - DNS query to suspicious registrar domain"; dns.query; content:"shady-registrar.test"; nocase; classtype:bad-unknown; sid:2000203; rev:1;)

# --- HTTP/TLS-based detection ---

# Detect HTTP traffic to phishing domain
alert http any any -> any any (msg:"SC02 - HTTP request to phishing domain"; http.host; content:"acmecorp-login.test"; nocase; classtype:social-engineering; sid:2000210; rev:1; metadata:scenario 02, mitre_attack T1071;)

# Detect HTTP POST to phishing login page (credential submission)
alert http any any -> any any (msg:"SC02 - Credential submission to phishing site"; http.method; content:"POST"; http.host; content:"acmecorp-login.test"; http.uri; content:"/login"; classtype:social-engineering; sid:2000211; rev:1; metadata:scenario 02, mitre_attack T1078;)

# Detect TLS connection to phishing domain via SNI
alert tls any any -> any 443 (msg:"SC02 - TLS SNI to phishing domain acmecorp-login.test"; tls.sni; content:"acmecorp-login.test"; nocase; classtype:social-engineering; sid:2000212; rev:1;)

# Detect TLS connection to spoofed domain via SNI
alert tls any any -> any 443 (msg:"SC02 - TLS SNI to spoofed domain acmec0rp.local"; tls.sni; content:"acmec0rp.local"; nocase; classtype:social-engineering; sid:2000213; rev:1;)

# --- Credential exfiltration detection ---

# Detect outbound connection to attacker credential-harvesting endpoint
alert tcp $HOME_NET any -> 203.0.113.50 8443 (msg:"SC02 - Outbound connection to attacker credential harvester"; flow:to_server,established; classtype:trojan-activity; sid:2000220; rev:1; metadata:scenario 02, mitre_attack T1041;)

# Detect large outbound data transfer to attacker IP
alert tcp $HOME_NET any -> 203.0.113.50 443 (msg:"SC02 - Large data transfer to attacker IP (potential exfiltration)"; flow:to_server,established; dsize:>10000; classtype:trojan-activity; sid:2000221; rev:1; metadata:scenario 02, mitre_attack T1041;)

# --- HTTrack / site cloning detection ---

# Detect HTTrack User-Agent (site cloning tool)
alert http any any -> $HOME_NET any (msg:"SC02 - HTTrack site cloning tool detected"; http.user_agent; content:"HTTrack"; nocase; classtype:web-application-activity; sid:2000230; rev:1;)

# --- Email-based indicators (if email traffic is inspected) ---

# Detect SMTP traffic from spoofed domain
alert smtp any any -> any 25 (msg:"SC02 - SMTP from spoofed domain acmec0rp.local"; smtp.mail_from; content:"acmec0rp.local"; nocase; classtype:social-engineering; sid:2000240; rev:1;)
