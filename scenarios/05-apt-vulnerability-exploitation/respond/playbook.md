# Incident Response Playbook: APT Vulnerability Exploitation

## Scenario 05 - Multi-Stage APT Attack via Web Application Exploit

### Severity: CRITICAL
### MITRE ATT&CK: T1190 (Exploit Public App), T1210 (Exploit Remote Svc), T1059 (Command Interpreter), T1505 (Web Shell), T1068 (Privilege Escalation)

---

## 1. Detection
- [ ] Suricata alert: Port scan and web vulnerability scanner detected (SID 9050001-9050002)
- [ ] Suricata alert: SQL injection attempt on web application (SID 9050003)
- [ ] Wazuh alert: Web shell uploaded to server (rule 100423)
- [ ] Wazuh alert: Post-exploitation tool download from C2 (rule 100425)
- [ ] Wazuh alert: Privilege escalation exploit executed (rule 100426)
- [ ] Wazuh alert: Lateral movement via compromised credentials (rule 100427)
- [ ] Wazuh alert: Multi-stage APT attack correlated (rule 100428)
- [ ] Anomalous outbound connections from DMZ web server to internal network

## 2. Triage (First 15 minutes)
- [ ] Confirm the alert is a true positive (not a penetration test or vulnerability scan)
- [ ] Identify the attacker's source IP and any proxy/pivot IPs
- [ ] Determine the initial access vector (which vulnerability was exploited)
- [ ] Assess the current stage of the APT (recon, exploitation, foothold, lateral movement)
- [ ] Identify all compromised hosts by reviewing network flow logs
- [ ] Check if any data exfiltration has occurred
- [ ] Escalate to incident commander and notify CISO

## 3. Containment (First 30 minutes)

### 3a. Immediate Containment
- [ ] **Isolate the DMZ web server** from both internal and external networks
- [ ] **Block the attacker IP** at the perimeter firewall
- [ ] **Block the C2 server IP** and domain at firewall and DNS level
- [ ] **Disable lateral movement paths** from DMZ to internal network
- [ ] **Do NOT power off compromised hosts** -- preserve volatile evidence

### 3b. Credential Containment
- [ ] Force password change for all accounts accessed from compromised hosts
- [ ] Revoke and regenerate all SSH keys on affected systems
- [ ] Rotate service account passwords (svc_web, svc_db, etc.)
- [ ] Invalidate all active sessions on compromised hosts

### Containment Commands
```bash
# Isolate DMZ web server
iptables -A INPUT -s 10.0.1.10 -j DROP
iptables -A OUTPUT -d 10.0.1.10 -j DROP
iptables -A FORWARD -s 10.0.1.10 -j DROP

# Block attacker and C2
iptables -A INPUT -s 203.0.113.50 -j DROP
iptables -A OUTPUT -d 203.0.113.100 -j DROP

# Block C2 domain
echo "203.0.113.100 updates.evil-cdn.test" >> /etc/hosts

# Run automated containment
python3 respond/containment.py
```

## 4. Eradication

### 4a. Web Server Cleanup
- [ ] Remove all web shells from the server
- [ ] Remove attacker tools from /tmp and other directories
- [ ] Remove persistence mechanisms (crontab entries, startup scripts)
- [ ] Patch the exploited vulnerability (DVWA or equivalent)
- [ ] Update web application to latest version
- [ ] Rebuild the web server from known-good image if possible

### 4b. Internal Host Cleanup
- [ ] Scan domain controller for unauthorized changes (new users, GPO modifications)
- [ ] Check file server for unauthorized access or data staging
- [ ] Verify database server integrity (no unauthorized queries, no data dumps)
- [ ] Run rootkit detection on all compromised hosts

### 4c. Vulnerability Remediation
- [ ] Patch CVE-2021-4034 (pkexec) on all Linux hosts
- [ ] Remove or disable DVWA/test applications from production DMZ
- [ ] Implement input validation and parameterized queries
- [ ] Restrict file upload functionality with proper validation
- [ ] Harden web server configuration (disable unnecessary modules)

```bash
# Remove web shell artifacts
find /var/www -name '*.php' -newer /var/www/html/index.html
rm -f /var/www/html/dvwa/hackable/uploads/shell.php

# Remove attacker tools
rm -f /tmp/.linpeas.sh /tmp/.pspy64 /tmp/.mimikatz.exe /tmp/.chisel /tmp/.nmap-static

# Remove persistence
crontab -u www-data -r

# Patch PwnKit
apt update && apt install -y policykit-1
```

## 5. Recovery
- [ ] Rebuild compromised web server from clean image
- [ ] Restore internal hosts from verified clean backups if needed
- [ ] Re-enable network connectivity in stages (monitor closely)
- [ ] Implement network segmentation between DMZ and internal
- [ ] Deploy Web Application Firewall (WAF) in front of web server
- [ ] Enable enhanced logging on all recovered systems
- [ ] Monitor for attacker return (same TTPs, IPs, or C2 domains) for 30 days
- [ ] Perform vulnerability scan on all DMZ-facing systems

## 6. Lessons Learned
- [ ] Document complete timeline from initial access to containment
- [ ] Calculate dwell time (how long attacker had access before detection)
- [ ] Identify why each attack phase was or was not detected
- [ ] Assess network segmentation effectiveness (DMZ to internal)
- [ ] Review patch management process (why was PwnKit unpatched?)
- [ ] Evaluate whether WAF would have blocked initial exploitation
- [ ] Review credential management (why could web server reach DC?)

## 7. Prevention Measures
- Deploy Web Application Firewall (WAF) with OWASP Core Rule Set
- Implement strict network segmentation between DMZ and internal networks
- Enforce principle of least privilege for DMZ service accounts
- Maintain aggressive patch management for all public-facing systems
- Disable file upload or enforce strict file type validation
- Use parameterized queries and input validation against SQLi/RCE
- Deploy EDR on DMZ servers for runtime protection
- Implement east-west network monitoring between zones
- Regular vulnerability scanning and penetration testing
- Use jump boxes for administrative access rather than direct SSH
