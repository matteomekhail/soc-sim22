#!/usr/bin/env python3
"""
Scenario 05: Automated containment response for APT vulnerability exploitation.

Actions:
1. Isolate compromised DMZ web server
2. Block attacker IP and C2 server at firewall
3. Revoke compromised credentials
4. Remove web shell and attacker tools
5. Block lateral movement paths
6. Preserve evidence
"""

import json
import os
import sys
from datetime import datetime

from colorama import Fore, Style, init

sys.path.insert(0, os.path.join(os.path.dirname(__file__), "..", "..", ".."))

from wcace_lib.constants import (
    ATTACKER_IP,
    C2_SERVER_IP,
    C2_DOMAIN,
    WEB_SERVER_IP,
    DC_IP,
    FILE_SERVER_IP,
    DB_SERVER_IP,
)

init(autoreset=True)


def isolate_host(host_ip: str, host_name: str) -> list[str]:
    """Generate firewall rules to isolate a compromised host."""
    rules = [
        f"iptables -A INPUT -s {host_ip} -j DROP",
        f"iptables -A OUTPUT -d {host_ip} -j DROP",
        f"iptables -A FORWARD -s {host_ip} -j DROP",
        f"iptables -A FORWARD -d {host_ip} -j DROP",
    ]
    print(f"    [+] Network isolation rules for {host_name} ({host_ip})")
    return rules


def block_external_threats() -> list[str]:
    """Generate rules to block attacker IP and C2 infrastructure."""
    rules = [
        f"iptables -A INPUT -s {ATTACKER_IP} -j DROP",
        f"iptables -A OUTPUT -d {C2_SERVER_IP} -j DROP",
        f"iptables -A FORWARD -d {C2_SERVER_IP} -j DROP",
    ]
    dns_rules = [
        f"# Add to DNS blackhole / Pi-hole blocklist:",
        f"echo '{C2_DOMAIN}' >> /etc/pihole/blacklist.txt",
    ]
    return rules + dns_rules


def generate_webshell_removal() -> list[str]:
    """Generate commands to remove web shells and attacker tools."""
    return [
        "# Remove uploaded web shell",
        "rm -f /var/www/html/dvwa/hackable/uploads/shell.php",
        "rm -f /var/www/html/dvwa/hackable/uploads/*.php",
        "",
        "# Remove attacker tools from /tmp",
        "rm -f /tmp/.linpeas.sh",
        "rm -f /tmp/.pspy64",
        "rm -f /tmp/.mimikatz.exe",
        "rm -f /tmp/.chisel",
        "rm -f /tmp/.nmap-static",
        "",
        "# Remove crontab persistence",
        "crontab -u www-data -r",
        "",
        "# Check for other web shells",
        "find /var/www -name '*.php' -newer /var/www/html/index.html -exec ls -la {} \\;",
        "grep -rl 'eval\\|exec\\|system\\|passthru\\|shell_exec' /var/www/html/dvwa/hackable/",
    ]


def revoke_credentials() -> list[str]:
    """Generate commands to revoke compromised credentials."""
    return [
        "# Force password change for compromised accounts",
        "passwd --expire root",
        "passwd --expire sysadmin",
        "passwd --expire svc_web",
        "",
        "# Regenerate SSH host keys",
        "ssh-keygen -A",
        "",
        "# Revoke stolen SSH keys",
        "find /home -name 'authorized_keys' -exec truncate -s 0 {} \\;",
        "",
        "# Rotate MySQL root password",
        "mysql -u root -e \"ALTER USER 'root'@'localhost' IDENTIFIED BY 'NEW_SECURE_PASSWORD';\"",
        "",
        "# Kill all active sessions for compromised users",
        "pkill -u svc_web",
        "pkill -u www-data",
    ]


def generate_suricata_emergency_rules() -> list[str]:
    """Generate emergency Suricata rules."""
    return [
        f'drop ip {ATTACKER_IP} any -> any any (msg:"WCACE S05: Block APT attacker"; sid:9059001; rev:1;)',
        f'drop ip any any -> {C2_SERVER_IP} any (msg:"WCACE S05: Block C2 server"; sid:9059002; rev:1;)',
        f'drop tcp {WEB_SERVER_IP} any -> $HOME_NET [22,445,3389] (msg:"WCACE S05: Block lateral from compromised DMZ"; sid:9059003; rev:1;)',
    ]


def preserve_evidence(logs_dir: str) -> str:
    """Create evidence package for the incident."""
    evidence = {
        "incident_id": f"INC-{datetime.now().strftime('%Y%m%d-%H%M%S')}",
        "type": "APT Vulnerability Exploitation",
        "severity": "CRITICAL",
        "mitre_techniques": ["T1190", "T1210", "T1059", "T1505", "T1068"],
        "attacker_ip": ATTACKER_IP,
        "c2_server": C2_SERVER_IP,
        "c2_domain": C2_DOMAIN,
        "compromised_hosts": [
            {"ip": WEB_SERVER_IP, "role": "DMZ Web Server", "access_level": "root"},
            {"ip": DC_IP, "role": "Domain Controller", "access_level": "sysadmin"},
            {"ip": FILE_SERVER_IP, "role": "File Server", "access_level": "svc_web"},
            {"ip": DB_SERVER_IP, "role": "Database Server", "access_level": "root (mysql)"},
        ],
        "timestamp": datetime.now().isoformat(),
        "containment_actions": [
            "DMZ web server network isolated",
            "Attacker IP and C2 server blocked at firewall",
            "Web shell and attacker tools removed",
            "Compromised credentials revoked and rotated",
            "Lateral movement paths blocked",
            "Emergency Suricata drop rules deployed",
        ],
        "evidence_files": [],
    }

    if os.path.exists(logs_dir):
        for f in os.listdir(logs_dir):
            evidence["evidence_files"].append(os.path.join(logs_dir, f))

    evidence_file = os.path.join(logs_dir, "incident_evidence.json")
    os.makedirs(logs_dir, exist_ok=True)
    with open(evidence_file, "w") as f:
        json.dump(evidence, f, indent=2)

    return evidence_file


def main():
    print(f"""
{Fore.RED}{'='*62}
  WCACE Scenario 05: APT Containment Response
  Incident: Multi-stage APT Vulnerability Exploitation
  Severity: CRITICAL
{'='*62}{Style.RESET_ALL}
""")

    logs_dir = os.path.join(os.path.dirname(__file__), "..", "logs", "sample_logs")

    # Step 1: Isolate compromised DMZ host
    print(f"{Fore.YELLOW}[1] Isolating compromised DMZ web server...{Style.RESET_ALL}")
    fw_rules = isolate_host(WEB_SERVER_IP, "DMZ Web Server")
    for rule in fw_rules[:2]:
        print(f"    -> {rule}")
    print(f"    -> ... {len(fw_rules)} rules total")

    # Step 2: Block external threats
    print(f"\n{Fore.YELLOW}[2] Blocking attacker IP and C2 infrastructure...{Style.RESET_ALL}")
    ext_rules = block_external_threats()
    print(f"    [+] Attacker IP blocked: {ATTACKER_IP}")
    print(f"    [+] C2 server blocked: {C2_SERVER_IP}")
    print(f"    [+] C2 domain blackholed: {C2_DOMAIN}")

    # Step 3: Remove web shell and tools
    print(f"\n{Fore.YELLOW}[3] Removing web shell and attacker tools...{Style.RESET_ALL}")
    removal_cmds = generate_webshell_removal()
    active_cmds = [c for c in removal_cmds if c and not c.startswith("#")]
    print(f"    [+] {len(active_cmds)} cleanup commands generated")
    print(f"    [+] Web shell: /dvwa/hackable/uploads/shell.php")
    print(f"    [+] Tools: linpeas, pspy, mimikatz, chisel, nmap")

    # Step 4: Revoke compromised credentials
    print(f"\n{Fore.YELLOW}[4] Revoking compromised credentials...{Style.RESET_ALL}")
    cred_cmds = revoke_credentials()
    print(f"    [+] Password expiry forced: root, sysadmin, svc_web")
    print(f"    [+] SSH keys regenerated and authorized_keys cleared")
    print(f"    [+] MySQL root password rotation queued")
    print(f"    [+] Active sessions for compromised users terminated")

    # Step 5: Emergency Suricata rules
    print(f"\n{Fore.YELLOW}[5] Deploying emergency Suricata rules...{Style.RESET_ALL}")
    suricata_rules = generate_suricata_emergency_rules()
    for rule in suricata_rules:
        print(f"    -> {rule[:80]}...")

    # Step 6: Preserve evidence
    print(f"\n{Fore.YELLOW}[6] Preserving evidence...{Style.RESET_ALL}")
    evidence_path = preserve_evidence(logs_dir)
    print(f"    -> Evidence saved to: {evidence_path}")

    # Summary
    print(f"\n{Fore.GREEN}{'='*62}")
    print(f"  Containment Actions Summary")
    print(f"{'='*62}{Style.RESET_ALL}")
    print(f"  Compromised hosts:  4 (web server, DC, file server, DB)")
    print(f"  Firewall rules:     {len(fw_rules) + len(ext_rules)} rules generated")
    print(f"  Artifacts removed:  Web shell + 5 post-exploitation tools")
    print(f"  Credentials:        3 accounts expired, SSH keys rotated")
    print(f"  Suricata:           {len(suricata_rules)} emergency drop rules")
    print(f"  Evidence:           {evidence_path}")
    print(f"\n  Next steps: Review respond/playbook.md for full IR procedure")


if __name__ == "__main__":
    main()
