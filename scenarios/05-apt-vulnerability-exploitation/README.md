# Scenario 05: APT Vulnerability Exploitation

## Overview
Simulate a multi-stage Advanced Persistent Threat (APT) that exploits a public-facing web application vulnerability to establish an initial foothold, then methodically deploys post-exploitation tools, escalates privileges, and moves laterally through the network.

This scenario uses a simulated approach with partial implementation -- the attack stages are scripted and generate realistic log sequences rather than performing live exploitation.

## Tier
**Tier 2** -- Simulated with partial implementation

## MITRE ATT&CK Mapping

| Tactic | Technique | ID |
|--------|-----------|-----|
| Initial Access | Exploit Public-Facing Application | T1190 |
| Lateral Movement | Exploitation of Remote Services | T1210 |
| Execution | Command and Scripting Interpreter | T1059 |
| Persistence | Server Software Component: Web Shell | T1505 |
| Privilege Escalation | Exploitation for Privilege Escalation | T1068 |
| Defense Evasion | Obfuscated Files or Information | T1027 |

## Attack Flow

```
Phase 1: Reconnaissance          Phase 2: Web Exploitation         Phase 3: Foothold
(Port scan & vuln probe)         (DVWA SQL injection + RCE)        (Web shell deployment)
  |                                |                                 |
  v                                v                                 v
Nmap-style scan of DMZ    -->  SQLi on login form +           -->  PHP web shell uploaded
web server (10.0.1.10)         command injection via              to /var/www/uploads/
                               vulnerable parameter                shell.php
  |                                |                                 |
  v                                v                                 v
Phase 4: Tool Deployment         Phase 5: Privilege Escalation     Phase 6: Lateral Movement
(Post-exploitation tools)        (Kernel exploit simulation)       (Pivot to internal hosts)
  |                                |                                 |
  v                                v                                 v
Download mimikatz/linpeas  -->  Exploit CVE-2021-4034        -->  SSH to DC + file server
from C2 server                  (PwnKit) for root access          using harvested creds
```

## Components

### Attack Simulation (`attack/simulate_attack.py`)
- Six-phase APT progression from reconnaissance through lateral movement
- Generates web access logs, IDS alerts, authentication events, and process execution logs
- Simulates DVWA-style exploitation without requiring a live vulnerable application

### Detection Rules
- **Suricata**: `config/suricata-rules.rules` -- Web exploit signatures, web shell detection, C2 tool download patterns
- **Wazuh**: `config/wazuh-rules.xml` -- Multi-stage APT correlation rules (rule IDs 100420-100428)

### Verification (`detect/verify_detection.py`)
- Analyzes generated logs for APT exploitation indicators
- Checks for SQLi patterns, web shell activity, privilege escalation, lateral movement
- Reports detection coverage across all attack phases

### Response
- **Containment**: `respond/containment.py` -- Isolate compromised hosts, block C2, revoke credentials
- **Playbook**: `respond/playbook.md` -- Full IR playbook for APT vulnerability exploitation

## How to Run

```bash
# 1. Run the attack simulation (generates logs)
python3 attack/simulate_attack.py

# 2. Verify detection coverage
python3 detect/verify_detection.py

# 3. Execute containment response
python3 respond/containment.py

# 4. Review IR playbook
cat respond/playbook.md
```

## Prerequisites
- SOC stack running (`soc-stack/scripts/start-core.sh`)
- Or standalone mode (generates local log files in `logs/sample_logs/`)

## Expected Alerts
- Wazuh Rule 100420: Web vulnerability scanning detected
- Wazuh Rule 100421: SQL injection attempt on web application
- Wazuh Rule 100422: Remote code execution via web application
- Wazuh Rule 100423: Web shell uploaded to server
- Wazuh Rule 100424: Web shell command execution detected
- Wazuh Rule 100425: Post-exploitation tool download from C2
- Wazuh Rule 100426: Privilege escalation exploit executed
- Wazuh Rule 100427: Lateral movement via compromised credentials
- Wazuh Rule 100428: Multi-stage APT attack correlated
- Suricata SID 9050001-9050006: Web exploit and C2 signatures
