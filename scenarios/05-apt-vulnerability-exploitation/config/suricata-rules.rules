# Scenario 05: APT Vulnerability Exploitation Detection Rules for Suricata
# These rules supplement the global rules in soc-stack/suricata/rules/local.rules

# Detect port scanning activity (SYN scan pattern)
alert tcp any any -> $HOME_NET any (msg:"S05: APT Recon - Port scan detected"; flags:S; threshold:type both, track by_src, count 15, seconds 30; sid:9050001; rev:1; classtype:attempted-recon; metadata:mitre_technique T1190;)

# Detect web vulnerability scanner user agents (Nikto, Nmap NSE, sqlmap)
alert http any any -> $HOME_NET any (msg:"S05: APT Recon - Web vulnerability scanner detected"; flow:to_server,established; pcre:"/Nikto|Nmap|sqlmap|DirBuster|Gobuster|wfuzz/Hi"; sid:9050002; rev:1; classtype:web-application-attack; metadata:mitre_technique T1190;)

# Detect SQL injection attempts in HTTP requests
alert http any any -> $HOME_NET any (msg:"S05: APT Exploit - SQL injection attempt"; flow:to_server,established; pcre:"/(UNION\s+SELECT|OR\s+1=1|DROP\s+TABLE|information_schema|CONCAT\()/Ui"; sid:9050003; rev:1; classtype:web-application-attack; metadata:mitre_technique T1190;)

# Detect PHP web shell upload
alert http any any -> $HOME_NET any (msg:"S05: APT Foothold - PHP web shell upload detected"; flow:to_server,established; content:"POST"; http_method; content:".php"; http_uri; content:"multipart/form-data"; http_header; pcre:"/(eval|exec|system|passthru|shell_exec)\s*\(/i"; sid:9050004; rev:1; classtype:web-application-attack; metadata:mitre_technique T1505;)

# Detect tool download from external C2 (wget/curl to suspicious endpoints)
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"S05: APT C2 - Post-exploitation tool download"; flow:to_server,established; pcre:"/(linpeas|pspy|mimikatz|chisel|nmap-static)/i"; sid:9050005; rev:1; classtype:trojan-activity; metadata:mitre_technique T1210;)

# Detect lateral movement from DMZ to internal network
alert tcp $DMZ_NET any -> $HOME_NET [22,445,3389,3306] (msg:"S05: APT Lateral - DMZ server accessing internal services"; flow:to_server,established; threshold:type both, track by_src, count 3, seconds 300; sid:9050006; rev:1; classtype:attempted-admin; metadata:mitre_technique T1210;)
