<!-- Scenario 05: APT Vulnerability Exploitation Detection Rules for Wazuh -->
<group name="wcace,apt,vulnerability_exploitation,">

  <rule id="100420" level="6">
    <if_group>web|accesslog|ids</if_group>
    <match>Nmap|Nikto|vulnerability scanner|port scan</match>
    <description>WCACE S05: Web vulnerability scanning detected</description>
    <mitre>
      <id>T1190</id>
    </mitre>
    <group>recon,apt,</group>
  </rule>

  <rule id="100421" level="10">
    <if_group>web|accesslog|ids</if_group>
    <match>SQL Injection|UNION SELECT|OR 1=1|information_schema</match>
    <description>WCACE S05: SQL injection attempt on web application</description>
    <mitre>
      <id>T1190</id>
    </mitre>
    <group>sqli,apt,web_attack,</group>
  </rule>

  <rule id="100422" level="12">
    <if_group>web|ids|process_execution</if_group>
    <match>Command Injection|cmd=|;id|;whoami|;uname</match>
    <description>WCACE S05: Remote code execution via web application</description>
    <mitre>
      <id>T1190</id>
      <id>T1059</id>
    </mitre>
    <group>rce,apt,web_attack,</group>
  </rule>

  <rule id="100423" level="14">
    <if_group>syscheck|file_create</if_group>
    <match>shell.php|webshell|uploads/.*.php</match>
    <description>WCACE S05: Web shell uploaded to server</description>
    <mitre>
      <id>T1505</id>
    </mitre>
    <group>webshell,apt,persistence,</group>
  </rule>

  <rule id="100424" level="14">
    <if_group>process_execution</if_group>
    <match>www-data|apache|nginx</match>
    <regex>cat /etc/passwd|cat /etc/shadow|whoami|id|uname</regex>
    <description>WCACE S05: Web shell command execution detected</description>
    <mitre>
      <id>T1059</id>
      <id>T1505</id>
    </mitre>
    <group>webshell,apt,execution,</group>
  </rule>

  <rule id="100425" level="12">
    <if_group>data_transfer|file_create</if_group>
    <match>linpeas|pspy|mimikatz|chisel|nmap-static</match>
    <description>WCACE S05: Post-exploitation tool download from C2</description>
    <mitre>
      <id>T1210</id>
      <id>T1059</id>
    </mitre>
    <group>c2,apt,tool_transfer,</group>
  </rule>

  <rule id="100426" level="15">
    <if_group>process_execution|auth</if_group>
    <match>pkexec|pwnkit|privilege escalation|www-data to root</match>
    <description>WCACE S05: Privilege escalation exploit executed</description>
    <mitre>
      <id>T1068</id>
    </mitre>
    <group>privesc,apt,</group>
  </rule>

  <rule id="100427" level="14">
    <if_group>authentication_success|process_execution</if_group>
    <match>DMZ server accessing internal|lateral movement</match>
    <description>WCACE S05: Lateral movement via compromised credentials</description>
    <mitre>
      <id>T1210</id>
      <id>T1021</id>
    </mitre>
    <group>lateral_movement,apt,</group>
  </rule>

  <rule id="100428" level="15" frequency="3" timeframe="3600">
    <if_matched_group>apt</if_matched_group>
    <description>WCACE S05: Multi-stage APT attack correlated - Multiple indicators detected</description>
    <mitre>
      <id>T1190</id>
      <id>T1210</id>
    </mitre>
    <group>apt,correlation,critical,</group>
  </rule>

</group>
